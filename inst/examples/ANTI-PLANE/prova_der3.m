clear; clc;

%% TEST 1
% p11 =[0 0]; p12 =[1 0]; p22 =[1 1]; p21 =[0 1];
% srf = nrb4surf(p11,p12,p21,p22);
% 
% srf = nrbdegelev(srf,[2 2]);
% new_knots = linspace (0, 1, 3);
% new_knots = new_knots (2:end-1);
% srf = nrbkntins(srf, {new_knots, new_knots});
% 
% %% Plott
% figure
% nrbkntplot(srf)
% figure,
% nrbctrlplot(srf)
% [der, der2, der3] = nrbderiv(srf);
% [pnt, jac, hess, derhess] = nrbdeval(srf, der, der2, der3,{linspace(0,1,3), [0,0,0]});


%% TEST 2
srf.form = 'B-NURBS';
srf.dim = 4;
srf.number = [5 5];
srf.order = [4 4];
srf.knots = {[0 0 0 0 1 2 2 2 2], [0 0 0 0 1 2 2 2 2]};
srf.coefs = ones(4,5,5);
[der, der2, der3] = nrbderiv(srf);

[p,w] = nrbeval(der{1}, {linspace(0,1,3), linspace(0,1,3)});

%[pnt, jac, hess, derhess] = nrbdeval(srf, der, der2, der3,{linspace(0,1,3), linspace(0,1,3)});

%% TEST 3
% knots = {[0 0 0 1 1 1], [0 0 0 0.5 1 1 1]};
% coefs = ones (4,3,4);
% coefs(1,:,:) = reshape ([0 0 0 0; 1 1 1 1; 2 2 4 2], 1, 3, 4);
% coefs(2,:,:) = reshape ([0 1 2 3; 0 1 2 3; 0 1 4 3], 1, 3, 4);
% coefs(3,:,:) = reshape ([0 1 0 0; 0 0 0 0; 0 0 0 0], 1, 3, 4);
% coefs(4,:,:) = reshape ([1 1 1 1; 1 1 1 1; 1 1 2 1], 1, 3, 4);
% nrb = nrbmak (coefs, knots);
% [dnrb, dnrb2, dnrb3] = nrbderiv (nrb);
% X = linspace (0, 1, 4); Y = linspace (0, 1, 4);
% [pnt, jac, hess, derhess] = nrbdeval (nrb, dnrb, dnrb2, dnrb3, {X Y});
% [y, x] = meshgrid (X, Y);
% w = (2*x.^2.*y.^2 + 1) .* (y < 0.5) + (-6*x.^2.*y.^2 + 8*x.^2.*y - 2*x.^2 + 1) .* (y > 0.5);
% F = zeros ([3,size(x)]);
% 
% F(1,:,:) = ((2*x - 2) ./w + 2) .* (y<0.5) + (2 + (2*x-2)./w) .* (y > 0.5);
% 
% F(2,:,:) = (2 - (2*(y-1).^2)./w).*(y<0.5) + ...
%      ((-12*x.^2.*y.^2 + 16*x.^2.*y - 4*x.^2 + 2*y.^2 + 1)./w).*(y>0.5);
% 
% F(3,:,:) = (-2*y.*(3*y - 2).*(x - 1).^2./w) .* (y<0.5) + ...
%      (2*(x - 1).^2.*(y - 1).^2./w) .* (y>0.5); 
% 
% % Derivate prime lungo u
% dFdu = zeros ([3,size(x)]);
% 
% dFdu(1,:,:) = (((8*x - 4*x.^2).*y.^2 + 2)./w.^2).*(y<0.5) + ...
%      (((12*y.^2 - 16*y + 4).*x.^2 + (-24*y.^2 + 32*y - 8).*x + 2)./w.^2).*(y>0.5);
% 
% dFdu(2,:,:) = (8*x.*y.^2.*(y - 1).^2./w.^2).*(y<0.5) + ...
%      ((4*x.*(3*y - 1).*(2*y.^2 - 1).*(y - 1))./w.^2).*(y>0.5);
% 
% dFdu(3,:,:) = (-4*y.*(2.*x.*y.^2 + 1).*(3*y - 2).*(x - 1)./w.^2).*(y<0.5) + ...
%      ((-4*(x - 1).*(y - 1).^2.*(6*x.*y.^2 - 8*x.*y + 2*x - 1))./w.^2).*(y>0.5);
% 
% % Derivate prime lungo v
% dFdv = zeros ([3,size(x)]);
% 
% dFdv(1,:,:) = (-8*x.^2.*y.*(x - 1)./w.^2).*(y<0.5) + ...
%      (8*x.^2.*(3*y - 2).*(x - 1)./w.^2).*(y>0.5);
% 
% dFdv(2,:,:) = (-4*(2*y.*x.^2 + 1).*(y - 1)./w.^2).*(y<0.5) + ...
%      (((16*y.^2 - 20*y + 8).*x.^2 + 4*y)./w.^2).*(y>0.5);
% 
% dFdv(3,:,:) = (-4*(x - 1).^2.*(2*x.^2.*y.^2 + 3*y - 1)./w.^2).*(y<0.5) + ...
%      (4*(x - 1).^2.*(y - 1).*(2*x.^2 - 2*x.^2.*y + 1)./w.^2).*(y>0.5);
% 
% % Derivate seconde lungo u 
% d2Fduu = zeros ([3, size(x)]);
% 
% d2Fduu(1,:,:) = (-((48*x.^2 - 16*x.^3).*y.^4 + (24*x - 8).*y.^2)./w.^3).*(y<0.5) + ...
%      (((32*(3*y - 1).*(x - 1).*(y - 1))-(8*(3*y - 1).*(x - 3).*(y - 1).*w))./w.^3).*(y>0.5);
% 
% d2Fduu(2,:,:) = (-(8*y.^2.*(6*x.^2.*y.^2 - 1).*(y - 1).^2)./w.^3).*(y<0.5) + ...
%      ((4*(3*y - 1).*(2*y.^2 - 1).*(y - 1).*(18*x.^2.*y.^2 - 24*x.^2.*y + 6*x.^2 + 1))./w.^3).*(y>0.5);
% 
% d2Fduu(3,:,:) =  ((4*y.*(3*y - 2).*(8*x.^3.*y.^4 - 12*x.^2.*y.^4 + 6*x.^2.*y.^2 - 12*x.*y.^2 + 2*y.^2 - 1))./w.^3).*(y<0.5) + ...
%   ((4*(y - 1).^2.*(6*y.^2 - 8*y + 3) - 4*x.^3.*(y - 1).^2.*(72*y.^4 - 192*y.^3 + 176*y.^2 - 64*y + 8) + 4*x.^2.*(y - 1).^2.*(108*y.^4 - 288*y.^3 + 282*y.^2 - 120*y + 18) - 4*x.*(y - 1).^2.*(36*y.^2 - 48*y + 12))./w.^3) .* (y>0.5);
% 
% % Derivate seconde lungo v
% d2Fdvv = zeros ([3, size(x)]);
% 
% d2Fdvv(1,:,:) = (8*x.^2.*(6*x.^2.*y.^2 - 1).*(x - 1)./w.^3) .* (y<0.5) + ...
%       (8*x.^2.*(x - 1).*(54*x.^2.*y.^2 - 72*x.^2.*y + 26*x.^2 + 3)./w.^3) .* (y>0.5);
%  
% d2Fdvv(2,:,:) =  (-((48*y.^2 - 32*y.^3).*x.^4 + (- 24*y.^2 + 48*y - 8).*x.^2 + 4)./w.^3) .*(y<0.5) + ...
%        (((192*y.^3 - 360*y.^2 + 288*y - 88).*x.^4 + (72*y.^2 - 28).*x.^2 + 4)./w.^3) .* (y>0.5);
%  
% d2Fdvv(3,:,:) =  (4*(x - 1).^2.*(8*x.^4.*y.^3 + 18*x.^2.*y.^2 - 12*x.^2.*y - 3))./w.^3 .* (y<0.5) + ...
%      ((4*(x - 1).^2.*(24*x.^4 + 18*x.^2 + 1) + 4*y.^2.*(72*x.^4 + 18*x.^2).*(x - 1).^2 - 96*x.^4.*y.^3.*(x - 1).^2 - 4*y.*(72*x.^4 + 36*x.^2).*(x - 1).^2)./w.^3) .* (y>0.5);
% 
% % Derivate seconde miste uv
% 
% d2Fduv = zeros ([3, size(x)]);
% 
% d2Fduv(1,:,:) = (-(y.^3.*(32*x.^3 - 16*x.^4) - y.*(16*x - 24*x.^2))./w.^3) .* (y<0.5) + ...
%      (-(-8*(3*y - 2).*(6*y.^2 - 8*y + 2).*x.^4 + 8*(3*y - 2).*(12*y.^2 - 16*y + 4).*x.^3 + (48 - 72*y).*x.^2 + (48*y - 32).*x)./w.^3) .* (y>0.5);
% 
% d2Fduv(2,:,:) = (16*x.*y.*(y - 1).*(2*x.^2.*y.^2 + 2*y - 1)./w.^3) .* (y<0.5) + ...
%      (-(8*x.*(4*y.^2 - 5*y + 2))./w.^2 + (16*x.*(3*y - 2).*(2*y.^2 - 1))./w.^3) .* (y>0.5);
% 
% d2Fduv(3,:,:) = (-(8*(x - 1).*(4*x.^3.*y.^4 - 6*x.^2.*y.^3 + 6*x.^2.*y.^2 + 12*x.*y.^3 - 6*x.*y.^2 + 3*y - 1))./w.^3) .* (y<0.5) + ...
%      ((8*(x - 1).*(y - 1).*(12*x.^3.*y.^3 - 28*x.^3.*y.^2 + 20*x.^3.*y - 4*x.^3 + 6*x.^2.*y.^2 - 12*x.^2.*y + 6*x.^2 - 12*x.*y.^2 + 18*x.*y - 6*x + 1))./w.^3) .* (y>0.5);
%  
% %% PARTE NUOVA!!! 
%  
% % Derivate terze u
% d3Fduuu = zeros ([3, size(x)]);
% 
% d3Fduuu(1,:,:) = ( 12.*(4.*x.*y.^2).^2./w.^3 - 6.*(-2+2.*x).*(4.*x.*y.^2).^3./w.^4 - 24.*y.^2./w.^2 + 6.*(-2+2.*x).*16.*x.*y.^4./w.^3).*(y<0.5)+...
%     ( 12.*(-4.*x +16.*x.*y -12.*x.*y.^2)./w.^3 -6.*(-2+2.*x).*(-4.*x +16.*x.*y -12.*x.*y.^2).^3./w.^4 - 6.*(-4 + 16.*y -12.*y^2)./w.^2 + 6.*(-2+2.*x).*(-4.*x + 16.*x.*y -12.*x.*y.^2).*(-4 + 16.*y - 12.*y.^2)./w.^3).*(y>0.5);
% 
% d3Fduuu(2,:,:) = ( 12.*(-1+y).^2.*(4.*x.*y.^2).^3./w.^4 - 12.*(-1+y).^2.*(4.*x.*y.^2).*(4.*y.^2)./w.^3 ).*(y<0.5)+...
%     ( 3.*(-8+32.*y - 24.*y.^2).*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^2 + 6.*(-8.*x+32.*x.*y-24.*x.*y.^2).*(-4.*x+16.*x.*y-12.*x.*y.^2).^2./w.^3 - 6.*(1-4.*x.^2+16.*x.^2.*y+2.*y.^2-12.*x.^2.*y.^2).*(-4.*x+16.*x.*y-12.*x.*y.^2).^3./w.^4 + 3.*(-8.*x+32.*x.*y-24.*x.*y.^2).*(-4+16.*y-12.*y.^2)./w.^2 + 6.*(1-4.*x.^2+16.*x.^2.*y+2.*y.^2-12.*x.^2.*y.^2).*(-4.*x+16.*x.*y-12.*x.*y.^2).*(-4+16.*y-12.*y.^2)./w.^3 ).*(y>0.5);
% 
% d3Fduuu(3,:,:) = ( -12.*y.*(-2+2.*y).*(4.*x.*y.^2)./w.^2 - 24.*(-1+x).*y.*(-2+3.*y).*(4.*x.*y.^2).^2./w.^3 + 12.*(-1+x).^2.*y.*(-2+3.*y).*(4.*x.*y.^2).^3./w.^4 + 12.*(-1+x).*y.*(-2+3.*y).*(4.*y.^2)./w.^2 - 12.*(-1+x).^2.*y.*(-2+3.*y).*(4.*x.*y.^2).*(4.*y.^2)./w.^3 ).*(y<0.5)+...
%     (-12.*(-1+y).^2.*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^2 + 24.*(-1+x).*(-1+y).^2.*(-4.*x+16.*x.*y-12.*x.*y.^2).^2./w.^3 - 12.*(-1+x).^2.*(-1+y).^2.*(-4.*x+16.*x.*y-12.*x.*y.^2).^3./w.^4 - 12.*(-1+x).*(-1+y).^2.*(-4+16.*y-12.*y.^2)./w.^2 + 12.*(-1+x).^2.*(-1+y).^2.*(-4.*x+16.*x.*y-12.*x.*y.^2).*(-4+16.*y-12.*y.^2)./w.^3 ).*(y>0.5);
% 
% % Derivate terze v
% d3Fdvvv = zeros ([3, size(x)]);
% 
% d3Fdvvv(1,:,:) = ( -6.*(-2+2.*x).*(4.*x.^2.*y).^3./w.^4 + 6.*(-2+2.*x).*(4.*x.^2.*y).*(4.*x.^2)./w.^2 ).*(y<0.5)+...
%     ( -6.*(-2+2.*x).*(8.*x.^2 -12.*x.^2.*y).^3./w.^4 + 6.*(-2 + 2.*x).*(8.*x.^2 - 12.*x.^2.*y).*(-12.*x.^2)./w.^2 ).*(y>0.5);
% 
% d3Fdvvv(2,:,:) = ( 12.*(4.*x.^2.*y)./w.^2 - 24.*(-1+y).*(4.*x.^2.*y).^2./w.^3 + 12.*(-1+y).^2.*(4.*x.^2.*y).^3./w.^4 + 12.*(-1+y).*(2.*x.^2)./w.^2 - 12.*(-1+y).^2.*(4.*x.^2.*y).*(2.*x.^2)./w.^3 ).*(y<0.5)+...
%     ( -3.*(4-24.*x.^2).*(8.*x.^2-12.*x.^2.*y)./w.^2 + 6.*(16.*x.^2+4.*y-24.*x.^2.*y).*(8.*x.^2-12.*x.^2.*y).^2./w.^3 - 6.*(1-4.*x.^2+16.*x.^2.*y+2.*y.^2-12.*x.^2.*y.^2).*(8.*x.^2-12.*x.^2.*y).^3./w.^4 - 3.*(16.*x.^2+4.*y-24.*x.^2.*y).*(-12.*x.^2)./w.^2 + 6.*(1-4.*x.^2+16.*x.^2.*y+2.*y.^2-12.*x.^2.*y.^2).*(8.*x.^2-12.*x.^2.*y).*(12.*x.^2)./w.^3 ).*(y>0.5);
% 
% d3Fdvvv(3,:,:) = ( 36.*(-1+x).^2.*(4.*x.^2.*y)./w.^2 - 36.*(-1+x).^2.*y.*(4.*x.^2.*y).^2./w.^3 - 12.*(-1+x).^2.*(-2+3.*y).*(4.*x.^2.*y).^2./w.^3 + 12.*(-1+x).^2.*y.*(-2+3.*y).*(4.*x.^2.*y).^3./w.^4 + 18.*(-1+x).^2.*y.*(2.*x.^2)./w.^2 + 6.*(-1+x).^2.*(-2+3.*y).*(2.*x.^2)./w.^2 - 12.*(-1+x).^2.*y.*(-2+3.*y).*(4.*x.^2.*y).*(2.*x.^2)./w.^3 ).*(y<0.5)+...
%     ( -12.*(-1+x).^2.*(8.*x.^2-12.*x.^2.*y)./w.^2 + 24.*(-1+x).^2.*(-1+y).*(8.*x.^2-12.*x.^2.*y).^2./w.^3 - 12.*(-1+x).^2.*(-1+y).^2.*(8.*x.^2-12.*x.^2.*y).^3./w.^4 - 12.*(-1+x).^2.*(-1+y).*(-12.*x.^2)./w.^2 + 12.*(-1+x).^2.*(-1+y).^2.*(8.*x.^2-12.*x.^2.*y).*(-12.*x.^2)./w.^3 ).*(y>0.5);
% 
% % Derivate terze uuv
% d3Fduuv = zeros ([3, size(x)]);
% 
% d3Fduuv(1,:,:) = ( (8.*4.*x.^2.*y.*4.*x.*y.^2)./w.^3 - 6.*(-2+2.*x).*4.*x.^2.*y.*(4.*x.*y.^2).^2./w.^4 - 4.*8.*x.*y./w.^2 + 4.*(-2+2.*x).*(4.*x.*y.^2).*(8.*x.*y)./w.^3 + 2.*(-2+2.*x).*(4.*x.^2.*y).*(4.*y.^2)./w.^3 - (-2+2.*x).*(8.*y)./w.^2).*(y<0.5)+...
%     (8.*(8.*x.^2-12.*x.^2.*y).*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^3 - 6.*(-2+2.*x).*(8.*x.^2 - 12.*x.^2.*y).*(-4.*x+16.*x.*y-12.*x.*y.^2).^2./w.^4 - 4.*(16.*x-24.*x.*y)./w.^3 + 4.*(-2+2.*x).*(-4.*x + 16.*x.*y-12.*x.*y.^2).*(16.*x-24.*x.*y)./w.^3 + 2.*(-2+2.*x).*(8.*x.^2-12.*x.^2.*y).*(-4+16.*y-12.*y.^2)./w.^3 -(-2+2.*x).*(16-24.*y)./w.^2 ).*(y>0.5);
% 
% d3Fduuv(2,:,:) = ( 8.*(-1+y).*(4.*x.*y.^2).^2./w.^3 + 12.*(-1+y).^2.*(4.*x.^2.*y).*(4.*x.*y.^2).^2./w.^4 - 8.*(-1+y).^2.*(4.*x.*y.^2).*(2.*x.*y)./w.^3 + 4.*(-1+y).*(4.*y.^2)./w.^2 - 4.*(-1+y).^2.*(4.*x.^2.*y).*(4.*y.^2)./w.^3 + 2.*(-1+y).^2.*(2.*y)./w.^2 ).*(y<0.5)+...
%     ( (32-48.*y)./w - (-8+32.*y-24.*y.^2).*(8.*x.^2-12.*x.^2.*y)./w.^2 - 2.*(32.*x-48.*x.*y).*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^2 + 4.*(-8.*x+32.*x.*y-24.*x.*y.^2).*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^3 + 2.*(16.*x.^2+4.*y-24.*x.^2.*y).*(-4.*x+16.*x.*y-12.*x.*y.^2).^2./w.^3 + 6.*(1-4.*x.^2+16.*x.^2.*y+2.*y.^2-12.*x.^2.*y.^2).*(8.*x.^2-12.*x.^2.*y).*(-4.*x+16.*x.*y-12.*x.*y.^2).^2./w.^4 -2.*(-8.*x+32.*x.*y-24.*x.*y.^2).*(16.*x-24.*x.*y)./w.^2 + 4.*(1-4.*x.^2+16.*x.^2.*y+2.*y.^2-12.*x.^2.*y.^2).*(-4.*x+16.*x.*y-12.*x.*y.^2).*(16.*x-24.*x.*y)./w.^3 - (16.*x.^2+4.*y-24.*x.^2.*y).*(-4+16.*y-12.*y.^2)./w.^2 + 2.*(1-4.*x.^2+16.*x.^2.*y+2.*y.^2-12.*x.^2.*y.^2).*(8.*x.^2-12.*x.^2.*y).*(-4+16.*y-12.*y.^2)./w.^3 - (1-4.*x.^2+16.*x.^2.*y+2.*y.^2-12.*x.^2.*y.^2).*(16-24.*x.*y)./w.^2 ).*(y>0.5);
% 
% d3Fduuv(3,:,:) = ( -12.*y./w - 4.*(-2+3.*y)./w + 4.*y.*(-2+3.*y).*(4.*x.^2.*y)./w.^2 + 24.*(-1+x).*y.*(4.*x.*y.^2)./w.^2 + 8.*(-1+x).*(-2+3.*y).*(4.*x.*y.^2)./w.^2 - 16.*(-1+x).*y.*(-2+3.*y).*(4.*x.^2.*y).*(4.*x.*y.^2)./w.^3 - 12.*(-1+x).^2.*y.*(4.*x.*y.^2).^2./w.^3 - 4.*(-1+x).^2.*(-2+3.*y).*(4.*x.*y.^2).^2./w.^3 + 12.*(-1+x).^2.*y.*(-2+3.*y).*(4.*x.^2.*y).*(4.*x.*y.^2).^2./w.^4 + 8.*(-1+x).*y.*(-2+3.*y).*(2.*x.*y)./w.^2 - 8.*(-1+x).^2.*y.*(-2+3.*y).*(4.*x.*y.^2).*(2.*x.*y)./w.^3 + 6.*(-1+x).^2.*y.*(4.*y.^2)./w.^2 + 2.*(-1+x).^2.*(-2+3.*y).*(4.*y.^2)./w.^2 - 4.*(-1+x).^2.*(-2+3.*y).*(4.*x.^2.*y).*(4.*y.^2)./w.^3 + 2.*(-1+x).^2.*y.*(-2+3.*y).*(2.*y)./w.^2 ).*(y<0.5)+...
%     ( 8.*(-1+y)./w - 4.*(-1+y).^2.*(8.*x.^2-12.*x.^2.*y)./w.^2 - 16.*(-1+x).*(-1+y).*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^2 + 16.*(-1+x).*(-1+y).^2.*(8.*x.^2-12.*x.^2.*y).*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^3 + 8.*(-1+x).^2.*(-1+y).*(-4.*x+16.*x.*y-12.*x.*y.^2).^2./w.^3 - 12.*(-1+x).^2.*(-1+y).^2.*(8.*x.^2-12.*x.^2.*y).*(-4.*x+16.*x.*y-12.*x.*y.^2).^2./w.^4 - 8.*(-1+x).*(-1+y).^2.*(16.*x-24.*x.*y)./w.^2 + 8.*(-1+x).^2.*(-1+y).^2.*(-4.*x+16.*x.*y-12.*x.*y.^2).*(16.*x-24.*x.*y)./w.^3 - 4.*(-1+x).^2.*(-1+y).*(-4+16.*y-12.*y.^2)./w.^2 + 4.*(-1+x).^2.*(-1+y).^2.*(8.*x.^2-12.*x.^2.*y).*(-4+16.*y-12.*y.^2)./w.^3 - 2.*(-1+x).^2.*(-1+y).^2.*(16-24.*y)./w.^2 ).*(y>0.5);
% 
% % Derivate terze uvv
% d3Fduvv = zeros ([3, size(x)]);
% 
% d3Fduvv(1,:,:) = ( 4.*(4.*x.^2.*y).^2./w.^3 - 2.*(4.*x.^2)./w.^2 - 6.*(-2+2.*x).*(4.*x.^2.*y).^2.*(4.*x.*y.^2)./w.^4 + 2.*(-2+2.*x).*(4.*x.^2).*(4.*x.*y.^2)./w.^3 + 4.*(-2+2.*x).*(4.*x.^2.*y).*(8.*x.*y)./w.^3 - (-2+2.*x).*(8.*x)./w.^2 ).*(y<0.5)+...
%     ( 4.*(8.*x.^2-12.*x.^2.*y).^2./w.^3 - 2.*(-12.*x.^2)./w.^2 - 6.*(-2+2.*x).*(8.*x.^2-12.*x.^2.*y).^2.*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^4 + 2.*(-2+2.*x).*(-12.*x.^2).*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^3 + 4.*(-2+2.*x).*(8.*x.^2-12.*x.^2.*y).*(16.*x-24.*x.*y)./w.^3 - (-2+2.*x).*(-24.*x)./w.^2 ).*(y>0.5);
% 
% 
% d3Fduvv(2,:,:) = ( 4.*(4.*x.*y.^2)./w.^2 -16.*(-1+y).*(4.*x.^2.*y).*(4.*x.*y.^2)./w.^3 + 12.*(-1+y).^2.*(4.*x.^2.*y).^2.*(4.*x.*y.^2)./w.^4 -4.*(-1+y).^2.*(2.*x.^2).*(4.*x.*y.^2)./w.^3 + 8.*(-1+y).*(2.*x.*y)./w.^2 - 8.*(-1+y).^2.*(4.*x.^2.*y).*(2.*x.*y)./w.^3 + 2.*(-1+y).^2.*(2.*x)./w.^2  ).*(y<0.5)+...
%     ( 48.*x./w - 2.*(32.*x-48.*x.*y).*(8.*x.^2-12.*x.^2.*y)./w.^2 + 2.*(-8.*x+32.*x.*y-24.*x.*y.^2).*(8.*x.^2-12.*x.^2.*y).^2./w.^3 -(8.*x+32.*x.*y-24.*x.*y.^2).*(-12.*x.^2)./w.^2 - (4-24.*x.^2).*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^2 + 4.*(16.*x.^2+4.*y-24.*x.^2.*y).*(8.*x.^2-12.*x.^2.*y).*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^3 -6.*(1-4.*x.^2+16.*x.^2.*y-12.*x.^2.*y.^2).*(8.*x.^2-12.*x.^2.*y).^2.*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^4 + 2.*(1-4.*x.^2+16.*x.^2.*y+2.*y.^2-12.*x.^2.*y.^2).*(-12.*x.^2).*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^3 - 2.*(16.*x.^2+4.*y-24.*x.^2.*y).*(16.*x-24.*x.*y)./w.^2 + 4.*(1-4.*x.^2+16.*x.^2.*y+2.*y.^2-12.*x.^2.*y.^2).*(8.*x.^2-12.*x.^2.*y).*(16.*x-24.*x.*y)./w.^3 - (1-4.*x.^2+16.*x.^2.*y+2.*y.^2-12.*x.^2.*y.^2).*(-24.*x)./w.^2 ).*(y>0.5);
% 
% d3Fduvv(3,:,:) = ( -24.*(-1+x)./w + 24.*(-1+x).*y.*(4.*x.^2.*y)./w.^2 - 8.*(-1+x).*(-2+3.*y).*(4.*x.^2.*y).^2 + 4.*(-1+x).*y.*(-2+3.*y).*(2.*x.^2)./w.^2 + 12.*(-1+x).^2.*(4.*x.*y.^2)./w.^2 - 24.*(-1+x).^2.*y.*(4.*x.^2.*y).*(4.*x.*y.^2)./w.^3 - 8.*(-1+x).^2.*(-2+3.*y).*(4.*x.^2.*y).*(4.*x.*y.^2)./w.^3  + 12.*(-1+x).^2.*y.*(-2+3.*y).*(4.*x.^2.*y).^2.*(4.*x.*y.^2)./w.^4 - 4.*(-1+x).^2.*y.*(-2+3.*y).*(2.*x.^2).*(4.*x.*y.^2)./w.^3 + 12.*(-1+x).^2.*y.*(2.*x.*y)./w.^2 + 4.*(-1+x).^2.*(-2+3.*y).*(2.*x.*y)./w.^2 - 8.*(-1+x).^2.*y.*(-2+3.*y).*(4.*x.^2.*y).*(2.*x.*y)./w.^3 + 2.*(-1+x).^2.*y.*(-2+3.*y).*(2.*x)./w.^2 ).*(y<0.5)+...
%     ( 8.*(-1+x)./w - 16.*(-1+x).*(-1+y).*(8.*x.^2-12.*x.^2.*y)./w.^2 + 8.*(-1+x).*(-1+y).^2.*(8.*x.^2-12.*x.^2.*y).^2./w.^3 - 4.*(-1+x).*(-1+y).^2.*(-12.*x.^2)./w.^2 - 4.*(-1+x).^2.*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^2 + 16.*(-1+x).^2.*(-1+y).*(8.*x.^2-12.*x.^2.*y).*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^3 - 12.*(-1+x).^2.*(-1+y).^2.*(8.*x.^2-12.*x.^2.*y).^2.*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^4 + 4.*(-1+x).^2.*(-1+y).^2.*(-12.*x.^2).*(-4.*x+16.*x.*y-12.*x.*y.^2)./w.^3 - 8.*(-1+x).^2.*(-1+y).*(16.*x-24.*x.*y)./w.^2 + 8.*(-1+x).^2.*(-1+y).^2.*(8.*x.^2-12.*x.^2.*y).*(16.*x-24.*x.*y)./w.^3 - 2.*(-1+x).^2.*(-1+y).^2.*(-24.*x)./w.^2 ).*(y>0.5);
% 
% %%
% assert(F, pnt, 1e3*eps)
% assert(dFdu, jac{1}, 1e3*eps)
% assert(dFdv, jac{2}, 1e3*eps)
% assert(d2Fduu, hess{1,1}, 1e3*eps)
% assert(d2Fduv, hess{1,2}, 1e3*eps)
% assert(d2Fduv, hess{2,1}, 1e3*eps)
% assert(d2Fdvv, hess{2,2}, 1e3*eps)
% assert(d3Fduuu, derhess{1,1}, 1e3*eps)
% assert(d3Fdvvv, derhess{2,2}, 1e3*eps)
% assert(d3Fduuv, derhess{1,2}, 1e3*eps)
% assert(d3Fduvv, derhess{2,1}, 1e3*eps)
% %